# üêç –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï: –ú–∏–≥—Ä–∞—Ü–∏—è SigmaTrade Bot –Ω–∞ Python

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-13  
**–¶–µ–ª–µ–≤–æ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** Claude Code  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 30-40 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã  

---

## üìã –û–ì–õ–ê–í–õ–ï–ù–ò–ï

1. [–û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–æ–±—â–∏–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
2. [–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#–ø—Ä–∞–≤–∏–ª–∞-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
4. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
5. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
6. [–î–µ—Ç–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π](#–¥–µ—Ç–∞–ª—å–Ω–∞—è-–º–∏–≥—Ä–∞—Ü–∏—è-–º–æ–¥—É–ª–µ–π)
7. [–¢–∏–ø–∏–∑–∞—Ü–∏—è](#—Ç–∏–ø–∏–∑–∞—Ü–∏—è)
8. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
9. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
10. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
11. [Docker –∏ Deployment](#docker-–∏-deployment)
12. [–ß–µ–∫-–ª–∏—Å—Ç—ã](#—á–µ–∫-–ª–∏—Å—Ç—ã)

---

## üéØ –û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞
–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å SigmaTrade Telegram Bot —Å TypeScript –Ω–∞ Python, 
—Å–æ—Ö—Ä–∞–Ω–∏–≤ **–í–°–Æ** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –ª–æ–≥–∏–∫—É –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ 100% —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ TypeScript –≤–µ—Ä—Å–∏–∏
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Production-ready –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –ß—Ç–æ –ù–ï –ü–û–¢–ï–†–Ø–¢–¨ (–∫—Ä–∏—Ç–∏—á–Ω–æ!)

#### 1. Telegram Bot —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
- –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (2+ —É—Ä–æ–≤–Ω—è)
- –°–∏—Å—Ç–µ–º–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ Web3
- –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–æ–≤ —Å—Ä–µ–¥—Å—Ç–≤
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- Support —Å–∏—Å—Ç–µ–º–∞ (—Ç–∏–∫–µ—Ç—ã)
- Broadcast —Å–æ–æ–±—â–µ–Ω–∏–π
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (Finpass)
- –ë–ª—ç–∫–ª–∏—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### 2. Blockchain –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ BNB –Ω–∞ BSC
- QuickNode RPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å rate limiting
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –±–ª–æ–∫–æ–≤
- Dead Letter Queue –¥–ª—è failed —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ PostgreSQL (19 entities)
- –ú–∏–≥—Ä–∞—Ü–∏–∏
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Backup —Å–∏—Å—Ç–µ–º–∞

#### 4. Background Jobs
- Blockchain –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- Payment processing
- Reward calculator (ROI —Å–∏—Å—Ç–µ–º–∞)
- Notification retry
- Cleanup jobs
- Disk guard

#### 5. Security
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Secret management (–ª–æ–∫–∞–ª—å–Ω–æ + GCP Secret Manager)
- Rate limiting
- Webhook authentication
- SQL injection protection
- XSS protection

---

## üìè –ü–†–ê–í–ò–õ–ê –†–ê–ó–†–ê–ë–û–¢–ö–ò

### –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø

#### 1. –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤
```
‚ùå –ù–ï –î–û–ü–£–°–ö–ê–ï–¢–°–Ø: —Ñ–∞–π–ª—ã > 500 —Å—Ç—Ä–æ–∫
‚úÖ –¢–†–ï–ë–£–ï–¢–°–Ø: —Ä–∞–∑–±–∏–≤–∞—Ç—å –Ω–∞ –º–æ–¥—É–ª–∏ –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç
```

**–ö–∞–∫ —Ä–∞–∑–±–∏–≤–∞—Ç—å:**
```python
# –ü–õ–û–•–û - –æ–¥–∏–Ω —Ñ–∞–π–ª 800 —Å—Ç—Ä–æ–∫
# services/user_service.py

# –•–û–†–û–®–û - —Ä–∞–∑–±–∏—Ç–æ –Ω–∞ –º–æ–¥—É–ª–∏
# services/user/
#   __init__.py        (—ç–∫—Å–ø–æ—Ä—Ç—ã)
#   user_service.py    (–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞, 350 —Å—Ç—Ä–æ–∫)
#   user_validators.py (–≤–∞–ª–∏–¥–∞—Ü–∏—è, 100 —Å—Ç—Ä–æ–∫)
#   user_helpers.py    (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ, 50 —Å—Ç—Ä–æ–∫)
```

#### 2. –î–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫
```
‚ùå –ù–ï –î–û–ü–£–°–ö–ê–ï–¢–°–Ø: —Å—Ç—Ä–æ–∫–∏ > 79 —Å–∏–º–≤–æ–ª–æ–≤
‚úÖ –¢–†–ï–ë–£–ï–¢–°–Ø: –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```python
# ‚ùå –ü–õ–û–•–û - 95 —Å–∏–º–≤–æ–ª–æ–≤
user = await session.execute(select(User).where(User.telegram_id == telegram_id).options(joinedload(User.referrals)))

# ‚úÖ –•–û–†–û–®–û - –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
user = await session.execute(
    select(User)
    .where(User.telegram_id == telegram_id)
    .options(joinedload(User.referrals))
)

# ‚ùå –ü–õ–û–•–û - –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
await message.answer(f"–í–∞—à –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ —Å—É–º–º—É {amount} BNB —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –ë–∞–ª–∞–Ω—Å: {balance}")

# ‚úÖ –•–û–†–û–®–û - –ø–µ—Ä–µ–Ω–æ—Å
await message.answer(
    f"–í–∞—à –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ —Å—É–º–º—É {amount} BNB —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.\n"
    f"–ë–∞–ª–∞–Ω—Å: {balance}"
)
```

#### 3. –†–∞–±–æ—Ç–∞ –≤ –≤–µ—Ç–∫–µ
```bash
# ‚ùå –ù–ï –î–û–ü–£–°–ö–ê–ï–¢–°–Ø: —Ä–∞–±–æ—Ç–∞ –≤ main/master
# ‚úÖ –¢–†–ï–ë–£–ï–¢–°–Ø: —Å–æ–∑–¥–∞—Ç—å –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–µ—Ç–∫–µ

git checkout -b feature/python-migration
# –í–°–Ø —Ä–∞–±–æ—Ç–∞ –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ
```

#### 4. –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
```python
# ‚úÖ –¢–†–ï–ë–£–ï–¢–°–Ø:
- Docstrings –¥–ª—è –í–°–ï–• –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π/–∫–ª–∞—Å—Å–æ–≤
- Type hints –≥–¥–µ —É–∫–∞–∑–∞–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–∏–ø–∏–∑–∞—Ü–∏—è"
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–µ–∑–¥–µ
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏

# ‚ùå –ù–ï –î–û–ü–£–°–ö–ê–ï–¢–°–Ø:
- –ö–æ–¥ –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –•–∞—Ä–¥–∫–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π
- print() –≤–º–µ—Å—Ç–æ logger
- pass –≤ except –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
```

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram Bot  ‚îÇ (aiogram 3.x)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Handlers ‚îÇ (–∫–æ–º–∞–Ω–¥—ã, callbacks)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Services  ‚îÇ (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Repositories   ‚îÇ (—Ä–∞–±–æ—Ç–∞ —Å –ë–î)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Database  ‚îÇ (SQLAlchemy + asyncpg)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Background   ‚îÇ (Dramatiq workers)
‚îÇ Jobs         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Blockchain   ‚îÇ (Web3.py + monitoring)
‚îÇ Monitor      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### 1. **Presentation Layer** (handlers/)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram —Å–æ–±—ã—Ç–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
- **–ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É**

#### 2. **Business Logic Layer** (services/)
- –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- **–ù–ï –∑–Ω–∞–µ—Ç –æ Telegram**

#### 3. **Data Access Layer** (repositories/)
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É**

#### 4. **Domain Layer** (models/)
- –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (SQLAlchemy)
- Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- Enums –∏ constants

---

## üõ†Ô∏è –¢–ï–•–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö

### –¢–æ—á–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏!)

```toml
# pyproject.toml –∏–ª–∏ requirements.txt

[tool.poetry.dependencies]
python = "^3.11"

# Telegram Bot
aiogram = "^3.3.0"              # –ù–ï 2.x!
aiohttp = "^3.9.0"

# Database
sqlalchemy = "^2.0.23"          # –ù–ï 1.4!
alembic = "^1.13.0"
asyncpg = "^0.29.0"
psycopg2-binary = "^2.9.9"      # –¥–ª—è alembic

# Web3
web3 = "^6.13.0"                # –ù–ï 5.x!
eth-account = "^0.10.0"

# Queue/Jobs
dramatiq = { version = "^1.15.0", extras = ["redis"] }
# –ò–õ–ò
celery = { version = "^5.3.4", extras = ["redis"] }

# Redis
redis = "^5.0.1"
hiredis = "^2.3.2"

# Validation
pydantic = "^2.5.0"
pydantic-settings = "^2.1.0"

# Encryption
cryptography = "^41.0.7"

# Logging
loguru = "^0.7.2"

# Utils
python-dotenv = "^1.0.0"
pytz = "^2023.3"

# HTTP
httpx = "^0.25.2"

# Development
mypy = "^1.7.1"
black = "^23.12.0"
ruff = "^0.1.8"
pytest = "^7.4.3"
pytest-asyncio = "^0.21.1"
pytest-cov = "^4.1.0"
```

### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏?

#### aiogram 3.x (–ù–ï 2.x)
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - aiogram 3.x
from aiogram import Bot, Dispatcher, Router
from aiogram.types import Message
from aiogram.filters import Command

router = Router()

@router.message(Command("start"))
async def start_handler(message: Message) -> None:
    await message.answer("Hello!")

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - aiogram 2.x (—Å—Ç–∞—Ä—ã–π API)
from aiogram import Bot, Dispatcher, executor
from aiogram.types import Message

@dp.message_handler(commands=['start'])
async def start_handler(message: Message):
    await message.answer("Hello!")
```

#### SQLAlchemy 2.0 (–ù–ï 1.4)
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - SQLAlchemy 2.0
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

async def get_user(session: AsyncSession, user_id: int):
    result = await session.execute(
        select(User).where(User.id == user_id)
    )
    return result.scalar_one_or_none()

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - SQLAlchemy 1.4 (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π API)
async def get_user(session: AsyncSession, user_id: int):
    return await session.query(User).filter(
        User.id == user_id
    ).first()
```

#### Dramatiq vs Celery
```python
# ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø - Dramatiq (–ª–µ–≥—á–µ, –±—ã—Å—Ç—Ä–µ–µ)
import dramatiq

@dramatiq.actor
async def process_deposit(deposit_id: int):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞."""
    ...

# ‚úÖ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê - Celery (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ workflows)
from celery import Celery

app = Celery('tasks', broker='redis://localhost')

@app.task
def process_deposit(deposit_id: int):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞."""
    ...
```

**–í—ã–±–æ—Ä:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Dramatiq** - –æ–Ω –ø—Ä–æ—â–µ –∏ async-native.

---

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

### –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å–æ–∑–¥–∞—Ç—å –í–°–Æ!)

```
sigmatrade-bot-python/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ bot/                         # Telegram Bot
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bot.py                   # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dispatcher.py            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/                # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py             # /start –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile.py           # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit/             # –î–µ–ø–æ–∑–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit_menu.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit_amount.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deposit_confirm.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal/          # –í—ã–≤–æ–¥—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_menu.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_amount.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ withdrawal_confirm.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral/            # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral_info.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referral_stats.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/               # –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_menu.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_management.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ broadcast.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ statistics.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support/             # Support —Ç–∏–∫–µ—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_ticket.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ticket_list.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ticket_reply.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common.py            # –û–±—â–∏–µ handlers
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keyboards/               # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py              # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ support.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middlewares/             # Middleware
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.py           # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py              # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py             # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ throttling.py        # Rate limiting
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db_session.py        # –ò–Ω—ä–µ–∫—Ü–∏—è —Å–µ—Å—Å–∏–∏ –ë–î
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filters/                 # –§–∏–ª—å—Ç—Ä—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ registered.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat_type.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ states/                  # FSM States
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ deposit.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ withdrawal.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ support.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ admin.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_service.py      # CRUD –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_validators.py   # –í–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_helpers.py      # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deposit_processor.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ withdrawal_processor.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reward_calculator.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referral_tree.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment_retry.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification_retry.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ support_service.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blacklist_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings_service.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blockchain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blockchain_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transaction_monitor.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ address_generator.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rpc_limiter.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ encryption.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ secret_manager.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ finpass.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ repositories/                # Data Access Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                  # –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transaction.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reward.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support_ticket.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support_message.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blacklist.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_session.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ models/                      # Database Models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                  # Base model
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transaction.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reward.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                     # Pydantic schemas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deposit.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ withdrawal.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transaction.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reward.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ database/                    # Database setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connection.py            # Async engine & session
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py               # Session dependency
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/              # Alembic migrations
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ env.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ script.py.mako
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ versions/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ (migration files)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ jobs/                        # Background jobs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ broker.py                # Dramatiq broker setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blockchain_monitor.py   # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment_processor.py    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reward_calculator.py    # –†–∞—Å—á–µ—Ç ROI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification_sender.py  # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cleanup.py              # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ disk_guard.py           # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ utils/                       # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ formatting.py            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.py            # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ datetime_helpers.py     # –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ money.py                 # –î–µ–Ω–µ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.py             # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ enums.py                 # Enums
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/                        # Core setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logging.py               # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py            # Custom exceptions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py          # FastAPI dependencies
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ api/                         # REST API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ app.py                   # FastAPI app
‚îÇ       ‚îú‚îÄ‚îÄ health.py                # Health check
‚îÇ       ‚îî‚îÄ‚îÄ webhook.py               # Telegram webhook
‚îÇ
‚îú‚îÄ‚îÄ tests/                           # –¢–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py                  # Fixtures
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_deposit_flow.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_withdrawal_flow.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_referral_system.py
‚îÇ   ‚îî‚îÄ‚îÄ e2e/
‚îÇ       ‚îî‚îÄ‚îÄ test_user_journey.py
‚îÇ
‚îú‚îÄ‚îÄ scripts/                         # –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ init_db.py                   # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ migrate.py                   # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ create_admin.py              # –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞
‚îÇ   ‚îî‚îÄ‚îÄ backup.py                    # Backup –ë–î
‚îÇ
‚îú‚îÄ‚îÄ alembic.ini                      # Alembic config
‚îú‚îÄ‚îÄ pyproject.toml                   # Poetry dependencies
‚îú‚îÄ‚îÄ requirements.txt                 # Pip dependencies
‚îú‚îÄ‚îÄ .env.example                     # –ü—Ä–∏–º–µ—Ä .env
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ mypy.ini                         # MyPy config
```

### –ü—Ä–∞–≤–∏–ª–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
user_service.py          # snake_case –¥–ª—è —Ñ–∞–π–ª–æ–≤
deposit_processor.py
referral_tree.py

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
UserService.py           # PascalCase –¥–ª—è —Ñ–∞–π–ª–æ–≤
depositProcessor.py      # camelCase –¥–ª—è —Ñ–∞–π–ª–æ–≤
```

---

## üîÑ –î–ï–¢–ê–õ–¨–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø –ú–û–î–£–õ–ï–ô

### –ú–û–î–£–õ–¨ 1: Database Models (models/)

#### TypeScript ‚Üí Python mapping

**TypeScript (entities/User.entity.ts):**
```typescript
@Entity('users')
export class User extends BaseEntity {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ unique: true })
  telegram_id: number;

  @Column({ nullable: true })
  username?: string;

  @Column({ type: 'decimal', precision: 18, scale: 8, default: 0 })
  balance: number;

  @ManyToOne(() => User, user => user.referrals, { nullable: true })
  referrer?: User;

  @OneToMany(() => User, user => user.referrer)
  referrals: User[];

  @CreateDateColumn()
  created_at: Date;
}
```

**Python (models/user.py):**
```python
"""User model."""
from decimal import Decimal
from datetime import datetime
from sqlalchemy import (
    BigInteger, String, DECIMAL, DateTime, ForeignKey
)
from sqlalchemy.orm import Mapped, mapped_column, relationship
from typing import Optional, List

from app.models.base import Base


class User(Base):
    """–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    
    __tablename__ = "users"

    # Columns
    id: Mapped[int] = mapped_column(primary_key=True)
    telegram_id: Mapped[int] = mapped_column(
        BigInteger, unique=True, index=True
    )
    username: Mapped[Optional[str]] = mapped_column(
        String(255), nullable=True
    )
    balance: Mapped[Decimal] = mapped_column(
        DECIMAL(18, 8), default=Decimal("0")
    )
    referrer_id: Mapped[Optional[int]] = mapped_column(
        ForeignKey("users.id"), nullable=True
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime, default=datetime.utcnow
    )

    # Relationships
    referrer: Mapped[Optional["User"]] = relationship(
        "User",
        remote_side=[id],
        back_populates="referrals",
        foreign_keys=[referrer_id]
    )
    referrals: Mapped[List["User"]] = relationship(
        "User",
        back_populates="referrer",
        foreign_keys=[referrer_id]
    )

    def __repr__(self) -> str:
        return (
            f"<User(id={self.id}, "
            f"telegram_id={self.telegram_id})>"
        )
```

#### –í–°–ï –º–æ–¥–µ–ª–∏ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. ‚úÖ **User** (users)
   - –§–∞–π–ª: `app/models/user.py`
   - –ü–æ–ª—è: id, telegram_id, username, first_name, last_name, 
           balance, referrer_id, is_active, is_verified, 
           registration_date, last_active, created_at, updated_at
   - Relations: referrer, referrals, deposits, withdrawals

2. ‚úÖ **Deposit** (deposits)
   - –§–∞–π–ª: `app/models/deposit.py`
   - –ü–æ–ª—è: id, user_id, amount, status, wallet_address, 
           transaction_hash, confirmations, created_at, 
           confirmed_at
   - Relations: user

3. ‚úÖ **Withdrawal** (withdrawals)
   - –§–∞–π–ª: `app/models/withdrawal.py`
   - –ü–æ–ª—è: id, user_id, amount, status, wallet_address, 
           transaction_hash, fee, created_at, processed_at
   - Relations: user

4. ‚úÖ **Transaction** (transactions)
   - –§–∞–π–ª: `app/models/transaction.py`
   - –ü–æ–ª—è: id, user_id, type, amount, balance_before, 
           balance_after, description, created_at
   - Relations: user

5. ‚úÖ **Referral** (referrals)
   - –§–∞–π–ª: `app/models/referral.py`
   - –ü–æ–ª—è: id, referrer_id, referred_id, level, created_at
   - Relations: referrer, referred

6. ‚úÖ **Reward** (rewards)
   - –§–∞–π–ª: `app/models/reward.py`
   - –ü–æ–ª—è: id, user_id, amount, type, source_user_id, 
           deposit_id, withdrawal_id, created_at
   - Relations: user, source_user, deposit, withdrawal

7. ‚úÖ **Notification** (notifications)
   - –§–∞–π–ª: `app/models/notification.py`
   - –ü–æ–ª—è: id, user_id, type, title, message, is_read, 
           retry_count, created_at, sent_at
   - Relations: user

8. ‚úÖ **SupportTicket** (support_tickets)
   - –§–∞–π–ª: `app/models/support.py`
   - –ü–æ–ª—è: id, user_id, category, status, subject, 
           created_at, updated_at, closed_at
   - Relations: user, messages

9. ‚úÖ **SupportMessage** (support_messages)
   - –§–∞–π–ª: `app/models/support.py`
   - –ü–æ–ª—è: id, ticket_id, sender_type, sender_id, 
           message, created_at
   - Relations: ticket

10. ‚úÖ **Blacklist** (blacklist)
    - –§–∞–π–ª: `app/models/admin.py`
    - –ü–æ–ª—è: id, user_id, reason, banned_by, banned_at, 
            expires_at
    - Relations: user, admin

11. ‚úÖ **AdminSession** (admin_sessions)
    - –§–∞–π–ª: `app/models/admin.py`
    - –ü–æ–ª—è: id, user_id, token, expires_at, created_at
    - Relations: user

12. ‚úÖ **Settings** (settings)
    - –§–∞–π–ª: `app/models/settings.py`
    - –ü–æ–ª—è: id, key, value, type, description, updated_at
    - Relations: none

13. ‚úÖ **UserWallet** (user_wallets)
    - –§–∞–π–ª: `app/models/wallet.py`
    - –ü–æ–ª—è: id, user_id, address, private_key_encrypted, 
            created_at
    - Relations: user

14. ‚úÖ **PaymentRetry** (payment_retries)
    - –§–∞–π–ª: `app/models/payment.py`
    - –ü–æ–ª—è: id, withdrawal_id, attempt_count, last_error, 
            next_retry_at, created_at
    - Relations: withdrawal

15. ‚úÖ **AuditLog** (audit_logs)
    - –§–∞–π–ª: `app/models/audit.py`
    - –ü–æ–ª—è: id, user_id, action, entity_type, entity_id, 
            old_value, new_value, ip_address, created_at
    - Relations: user

16. ‚úÖ **BroadcastMessage** (broadcast_messages)
    - –§–∞–π–ª: `app/models/broadcast.py`
    - –ü–æ–ª—è: id, admin_id, message, image_url, button_text, 
            button_url, sent_count, failed_count, 
            created_at, sent_at
    - Relations: admin

17. ‚úÖ **UserFinancialPassword** (user_financial_passwords)
    - –§–∞–π–ª: `app/models/finpass.py`
    - –ü–æ–ª—è: id, user_id, password_hash, failed_attempts, 
            last_failed_at, created_at
    - Relations: user

18. ‚úÖ **ROIConfiguration** (roi_configurations)
    - –§–∞–π–ª: `app/models/roi.py`
    - –ü–æ–ª—è: id, tier_name, min_amount, max_amount, 
            daily_percent, duration_days, is_active
    - Relations: none

19. ‚úÖ **UserROI** (user_roi)
    - –§–∞–π–ª: `app/models/roi.py`
    - –ü–æ–ª—è: id, user_id, roi_config_id, principal_amount, 
            start_date, end_date, total_earned, last_payout, 
            status
    - Relations: user, roi_config

#### –ü—Ä–∞–≤–∏–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π:

```python
# ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
1. –í—Å–µ —Ç–∏–ø—ã –ø–æ–ª–µ–π —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç TypeORM
2. –í—Å–µ relationships —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
3. –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
4. –í—Å–µ constraints (unique, foreign key) –Ω–∞ –º–µ—Å—Ç–µ
5. Default values –∏–¥–µ–Ω—Ç–∏—á–Ω—ã

# ‚úÖ –ü—Ä–∏–º–µ—Ä base model (models/base.py):
from datetime import datetime
from sqlalchemy import DateTime
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column


class Base(DeclarativeBase):
    """Base model —Å –æ–±—â–∏–º–∏ –ø–æ–ª—è–º–∏."""
    pass


class TimestampMixin:
    """Mixin –¥–ª—è created_at/updated_at."""
    
    created_at: Mapped[datetime] = mapped_column(
        DateTime, default=datetime.utcnow
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow
    )
```

---

### –ú–û–î–£–õ–¨ 2: Repositories (repositories/)

#### –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

**–§–∞–π–ª: `app/repositories/base.py`**
```python
"""Base repository with common CRUD operations."""
from typing import Generic, TypeVar, Type, Optional, List
from sqlalchemy import select, update, delete
from sqlalchemy.ext.asyncio import AsyncSession

from app.models.base import Base

ModelType = TypeVar("ModelType", bound=Base)


class BaseRepository(Generic[ModelType]):
    """
    –ë–∞–∑–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å CRUD –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏.
    
    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞—Å–ª–µ–¥—É–π—Ç–µ –æ—Ç –Ω–µ–≥–æ –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!
    """
    
    def __init__(
        self, 
        model: Type[ModelType], 
        session: AsyncSession
    ) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
        
        Args:
            model: SQLAlchemy –º–æ–¥–µ–ª—å
            session: Async database session
        """
        self.model = model
        self.session = session
    
    async def get_by_id(
        self, 
        entity_id: int
    ) -> Optional[ModelType]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ ID.
        
        Args:
            entity_id: ID –∑–∞–ø–∏—Å–∏
            
        Returns:
            –ù–∞–π–¥–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –∏–ª–∏ None
        """
        result = await self.session.execute(
            select(self.model).where(self.model.id == entity_id)
        )
        return result.scalar_one_or_none()
    
    async def get_all(
        self, 
        skip: int = 0, 
        limit: int = 100
    ) -> List[ModelType]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
        
        Args:
            skip: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º—ã—Ö –∑–∞–ø–∏—Å–µ–π
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π
        """
        result = await self.session.execute(
            select(self.model).offset(skip).limit(limit)
        )
        return list(result.scalars().all())
    
    async def create(self, **kwargs) -> ModelType:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å.
        
        Args:
            **kwargs: –ü–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
            
        Returns:
            –°–æ–∑–¥–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å
        """
        instance = self.model(**kwargs)
        self.session.add(instance)
        await self.session.flush()
        await self.session.refresh(instance)
        return instance
    
    async def update(
        self, 
        entity_id: int, 
        **kwargs
    ) -> Optional[ModelType]:
        """
        –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å.
        
        Args:
            entity_id: ID –∑–∞–ø–∏—Å–∏
            **kwargs: –ü–æ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            
        Returns:
            –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –∏–ª–∏ None
        """
        await self.session.execute(
            update(self.model)
            .where(self.model.id == entity_id)
            .values(**kwargs)
        )
        await self.session.flush()
        return await self.get_by_id(entity_id)
    
    async def delete(self, entity_id: int) -> bool:
        """
        –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.
        
        Args:
            entity_id: ID –∑–∞–ø–∏—Å–∏
            
        Returns:
            True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ, False –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        """
        result = await self.session.execute(
            delete(self.model).where(self.model.id == entity_id)
        )
        await self.session.flush()
        return result.rowcount > 0
```

#### –ü—Ä–∏–º–µ—Ä —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

**–§–∞–π–ª: `app/repositories/user.py`**
```python
"""User repository."""
from typing import Optional, List
from decimal import Decimal
from sqlalchemy import select, update
from sqlalchemy.orm import joinedload

from app.repositories.base import BaseRepository
from app.models.user import User


class UserRepository(BaseRepository[User]):
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏."""
    
    def __init__(self, session) -> None:
        super().__init__(User, session)
    
    async def get_by_telegram_id(
        self, 
        telegram_id: int
    ) -> Optional[User]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID.
        
        Args:
            telegram_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ None
        """
        result = await self.session.execute(
            select(User).where(
                User.telegram_id == telegram_id
            )
        )
        return result.scalar_one_or_none()
    
    async def get_with_referrals(
        self, 
        user_id: int
    ) -> Optional[User]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏.
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
        """
        result = await self.session.execute(
            select(User)
            .where(User.id == user_id)
            .options(joinedload(User.referrals))
        )
        return result.unique().scalar_one_or_none()
    
    async def update_balance(
        self, 
        user_id: int, 
        amount: Decimal, 
        operation: str = "add"
    ) -> Optional[User]:
        """
        –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            amount: –°—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            operation: "add" –∏–ª–∏ "subtract"
            
        Returns:
            –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        """
        user = await self.get_by_id(user_id)
        if not user:
            return None
        
        if operation == "add":
            new_balance = user.balance + amount
        else:
            new_balance = user.balance - amount
        
        if new_balance < 0:
            raise ValueError("Balance cannot be negative")
        
        await self.session.execute(
            update(User)
            .where(User.id == user_id)
            .values(balance=new_balance)
        )
        await self.session.flush()
        return await self.get_by_id(user_id)
    
    async def get_active_users(
        self, 
        skip: int = 0, 
        limit: int = 100
    ) -> List[User]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
        
        Args:
            skip: –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å–µ–π
            limit: –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Å–µ–π
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        """
        result = await self.session.execute(
            select(User)
            .where(User.is_active == True)
            .offset(skip)
            .limit(limit)
        )
        return list(result.scalars().all())
```

#### –°–ø–∏—Å–æ–∫ –í–°–ï–• —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:

1. ‚úÖ UserRepository (repositories/user.py)
2. ‚úÖ DepositRepository (repositories/deposit.py)
3. ‚úÖ WithdrawalRepository (repositories/withdrawal.py)
4. ‚úÖ TransactionRepository (repositories/transaction.py)
5. ‚úÖ ReferralRepository (repositories/referral.py)
6. ‚úÖ RewardRepository (repositories/reward.py)
7. ‚úÖ NotificationRepository (repositories/notification.py)
8. ‚úÖ SupportTicketRepository (repositories/support_ticket.py)
9. ‚úÖ SupportMessageRepository (repositories/support_message.py)
10. ‚úÖ BlacklistRepository (repositories/blacklist.py)
11. ‚úÖ AdminSessionRepository (repositories/admin_session.py)
12. ‚úÖ SettingsRepository (repositories/settings.py)
13. ‚úÖ UserWalletRepository (repositories/user_wallet.py)
14. ‚úÖ PaymentRetryRepository (repositories/payment_retry.py)
15. ‚úÖ AuditLogRepository (repositories/audit_log.py)
16. ‚úÖ BroadcastRepository (repositories/broadcast.py)
17. ‚úÖ FinpassRepository (repositories/finpass.py)
18. ‚úÖ ROIConfigRepository (repositories/roi_config.py)
19. ‚úÖ UserROIRepository (repositories/user_roi.py)

---

### –ú–û–î–£–õ–¨ 3: Services (services/)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É:**

```python
"""
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–ê–ñ–î–û–ì–û —Å–µ—Ä–≤–∏—Å–∞:

1. –ò–º–ø–æ—Ä—Ç—ã
2. Logger
3. –ö–ª–∞—Å—Å —Å–µ—Ä–≤–∏—Å–∞
4. __init__ (–∏–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
5. –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã (async)
6. –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã (async, prefix _)
7. –í–∞–ª–∏–¥–∞—Ü–∏—è (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ > 100 —Å—Ç—Ä–æ–∫)
"""
```

**–§–∞–π–ª: `app/services/user/user_service.py`**
```python
"""User service."""
from typing import Optional, List
from decimal import Decimal
from loguru import logger

from app.repositories.user import UserRepository
from app.repositories.transaction import TransactionRepository
from app.schemas.user import UserCreate, UserUpdate
from app.models.user import User
from app.core.exceptions import (
    UserNotFound,
    InsufficientBalance
)


class UserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏."""
    
    def __init__(
        self,
        user_repo: UserRepository,
        transaction_repo: TransactionRepository
    ) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞.
        
        Args:
            user_repo: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            transaction_repo: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        """
        self.user_repo = user_repo
        self.transaction_repo = transaction_repo
    
    async def create_user(
        self, 
        telegram_id: int,
        username: Optional[str] = None,
        referrer_id: Optional[int] = None
    ) -> User:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: Telegram ID
            username: Username (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            referrer_id: ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
        Returns:
            –°–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            
        Raises:
            ValueError: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        """
        logger.info(
            f"Creating user: telegram_id={telegram_id}, "
            f"referrer_id={referrer_id}"
        )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
        existing = await self.user_repo.get_by_telegram_id(
            telegram_id
        )
        if existing:
            raise ValueError(
                f"User {telegram_id} already exists"
            )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ
        user = await self.user_repo.create(
            telegram_id=telegram_id,
            username=username,
            referrer_id=referrer_id,
            balance=Decimal("0"),
            is_active=True,
            is_verified=False
        )
        
        logger.info(f"User created: id={user.id}")
        return user
    
    async def get_user(
        self, 
        user_id: int
    ) -> User:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID.
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            
        Raises:
            UserNotFound: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        user = await self.user_repo.get_by_id(user_id)
        if not user:
            raise UserNotFound(f"User {user_id} not found")
        return user
    
    async def add_balance(
        self,
        user_id: int,
        amount: Decimal,
        description: str = "Balance added"
    ) -> User:
        """
        –î–æ–±–∞–≤–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å.
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            amount: –°—É–º–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            description: –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            
        Returns:
            –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            
        Raises:
            UserNotFound: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            ValueError: –ï—Å–ª–∏ —Å—É–º–º–∞ <= 0
        """
        if amount <= 0:
            raise ValueError("Amount must be positive")
        
        logger.info(
            f"Adding balance: user_id={user_id}, "
            f"amount={amount}"
        )
        
        user = await self.get_user(user_id)
        balance_before = user.balance
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        user = await self.user_repo.update_balance(
            user_id, amount, operation="add"
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        await self.transaction_repo.create(
            user_id=user_id,
            type="credit",
            amount=amount,
            balance_before=balance_before,
            balance_after=user.balance,
            description=description
        )
        
        logger.info(
            f"Balance added: user_id={user_id}, "
            f"new_balance={user.balance}"
        )
        return user
    
    async def subtract_balance(
        self,
        user_id: int,
        amount: Decimal,
        description: str = "Balance subtracted"
    ) -> User:
        """
        –°–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –±–∞–ª–∞–Ω—Å–∞.
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            amount: –°—É–º–º–∞ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
            description: –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            
        Returns:
            –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            
        Raises:
            UserNotFound: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            InsufficientBalance: –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
            ValueError: –ï—Å–ª–∏ —Å—É–º–º–∞ <= 0
        """
        if amount <= 0:
            raise ValueError("Amount must be positive")
        
        logger.info(
            f"Subtracting balance: user_id={user_id}, "
            f"amount={amount}"
        )
        
        user = await self.get_user(user_id)
        
        if user.balance < amount:
            raise InsufficientBalance(
                f"Insufficient balance: has {user.balance}, "
                f"needs {amount}"
            )
        
        balance_before = user.balance
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        user = await self.user_repo.update_balance(
            user_id, amount, operation="subtract"
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        await self.transaction_repo.create(
            user_id=user_id,
            type="debit",
            amount=amount,
            balance_before=balance_before,
            balance_after=user.balance,
            description=description
        )
        
        logger.info(
            f"Balance subtracted: user_id={user_id}, "
            f"new_balance={user.balance}"
        )
        return user
```

#### –°–ø–∏—Å–æ–∫ –í–°–ï–• —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:

**1. User Service (services/user/)**
- `user_service.py` - CRUD, –±–∞–ª–∞–Ω—Å, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `user_validators.py` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ú–µ—Ç–æ–¥—ã: create_user, get_user, update_user, add_balance, 
          subtract_balance, verify_user, deactivate_user

**2. Deposit Service (services/deposit/)**
- `deposit_service.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- `deposit_processor.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- –ú–µ—Ç–æ–¥—ã: create_deposit, process_deposit, confirm_deposit,
          get_user_deposits, get_pending_deposits

**3. Withdrawal Service (services/withdrawal/)**
- `withdrawal_service.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –≤—ã–≤–æ–¥–æ–≤
- `withdrawal_processor.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–≤–æ–¥–æ–≤
- –ú–µ—Ç–æ–¥—ã: create_withdrawal, process_withdrawal, 
          cancel_withdrawal, get_user_withdrawals

**4. Referral Service (services/referral/)**
- `referral_service.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
- `reward_calculator.py` - —Ä–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥
- `referral_tree.py` - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- –ú–µ—Ç–æ–¥—ã: get_referrals, calculate_rewards, 
          get_referral_tree, get_referral_stats

**5. Payment Service (services/payment/)**
- `payment_service.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- `payment_retry.py` - retry –ª–æ–≥–∏–∫–∞
- –ú–µ—Ç–æ–¥—ã: process_payment, retry_payment, 
          cancel_payment

**6. Notification Service (services/notification/)**
- `notification_service.py` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `notification_retry.py` - retry –ª–æ–≥–∏–∫–∞
- –ú–µ—Ç–æ–¥—ã: send_notification, retry_notification,
          get_user_notifications, mark_as_read

**7. Support Service (services/support/)**
- `support_service.py` - —Ç–∏–∫–µ—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ú–µ—Ç–æ–¥—ã: create_ticket, add_message, close_ticket,
          get_user_tickets, get_open_tickets

**8. Admin Service (services/admin/)**
- `admin_service.py` - –∞–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
- `blacklist_service.py` - –±–ª—ç–∫–ª–∏—Å—Ç
- `settings_service.py` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ú–µ—Ç–æ–¥—ã: get_statistics, manage_user, broadcast,
          update_settings, ban_user, unban_user

**9. Blockchain Service (services/blockchain/)**
- `blockchain_service.py` - Web3 –æ–ø–µ—Ä–∞—Ü–∏–∏
- `transaction_monitor.py` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `address_generator.py` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤
- `rpc_limiter.py` - rate limiting –¥–ª—è RPC
- –ú–µ—Ç–æ–¥—ã: get_balance, send_transaction, 
          monitor_deposits, generate_address

**10. Security Service (services/security/)**
- `encryption.py` - —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `secret_manager.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏
- `finpass.py` - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
- –ú–µ—Ç–æ–¥—ã: encrypt, decrypt, verify_finpass, 
          set_finpass, get_secret

---

**–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –î–õ–ò–ù–ê: –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –†–∞–∑–±–∏–≤–∞—é –Ω–∞ 2 —á–∞—Å—Ç–∏.**

–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞? –û—Å—Ç–∞–ª–æ—Å—å –æ–ø–∏—Å–∞—Ç—å:
- Handlers (bot/)
- Schemas (Pydantic)
- Background Jobs
- Configuration
- Testing
- Docker
- –ß–µ–∫-–ª–∏—Å—Ç—ã

–°–æ–∑–¥–∞—Ç—å –ß–ê–°–¢–¨ 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞?

